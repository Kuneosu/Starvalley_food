name: Daily Menu Update

on:
  schedule:
    # 매일 오전 8시 (UTC 23:00 = KST 08:00)
    - cron: '0 23 * * *'
  workflow_dispatch: # 수동 실행 허용
    inputs:
      force_update:
        description: '강제 업데이트 (true/false)'
        required: false
        default: 'false'

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
  GITHUB_OWNER: ${{ github.repository_owner }}
  GITHUB_REPO: ${{ github.event.repository.name }}
  GITHUB_BRANCH: main

jobs:
  update-menu:
    runs-on: ubuntu-latest
    
    steps:
      - name: 🛒 Checkout repository
        uses: actions/checkout@v4
        
      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: 📥 Install dependencies
        run: npm install --production
        
      - name: 🔧 Install additional dependencies for GitHub Actions
        run: npm install dotenv
        
      - name: 🌐 Setup Chrome and dependencies
        run: |
          # Chrome이 이미 설치되어 있는지 확인
          if command -v google-chrome &> /dev/null; then
            echo "✅ Chrome already installed: $(google-chrome --version)"
          else
            echo "❌ Chrome not found, installing..."
            
            # Chrome 설치
            wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
            echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
            sudo apt-get update
            sudo apt-get install -y google-chrome-stable
          fi
          
          # Puppeteer가 시스템 Chrome을 사용하도록 설정
          echo "PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true" >> $GITHUB_ENV
          echo "PUPPETEER_EXECUTABLE_PATH=/usr/bin/google-chrome" >> $GITHUB_ENV
          
          # Chrome 버전 확인
          google-chrome --version
          
          # Chrome 실행 테스트
          google-chrome --headless --no-sandbox --disable-setuid-sandbox --dump-dom https://www.google.com > /dev/null
          echo "✅ Chrome headless test successful"
        
      - name: 🍽️ Process menu data
        id: process_menu
        run: |
          echo "Starting menu processing..."
          echo "Environment variables check:"
          echo "OPENAI_API_KEY: ${OPENAI_API_KEY:0:10}..."
          echo "GITHUB_TOKEN: ${GITHUB_TOKEN:0:10}..."
          echo "GITHUB_OWNER: $GITHUB_OWNER"
          echo "GITHUB_REPO: $GITHUB_REPO"
          echo "GITHUB_BRANCH: $GITHUB_BRANCH"
          echo "Working directory: $(pwd)"
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo ""
          
          node github-actions-workflow.js
          
      - name: 📊 Create summary
        if: always()
        run: |
          echo "## 📊 Menu Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "- **Result:** ✅ Successfully updated menu data" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Result:** ❌ Failed to update menu data" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- **Workflow Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          
      - name: 📱 Notify on failure
        if: failure()
        run: |
          echo "Menu update failed. Please check the workflow logs."
          # 필요시 Slack, Discord 등으로 알림 추가 가능
          
      - name: 🧹 Cleanup
        if: always()
        run: |
          echo "Workflow completed at $(date)"