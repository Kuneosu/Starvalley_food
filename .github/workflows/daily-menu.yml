name: Daily Menu Update

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 8ì‹œ (UTC 23:00 = KST 08:00)
    - cron: '0 23 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©
    inputs:
      force_update:
        description: 'ê°•ì œ ì—…ë°ì´íŠ¸ (true/false)'
        required: false
        default: 'false'

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GITHUB_OWNER: ${{ github.repository_owner }}
  GITHUB_REPO: ${{ github.event.repository.name }}
  GITHUB_BRANCH: main

jobs:
  update-menu:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ›’ Checkout repository
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ðŸ“¥ Install dependencies
        run: npm install --production
        
      - name: ðŸ”§ Install additional dependencies for GitHub Actions
        run: npm install dotenv
        
      - name: ðŸŒ Install Chrome for Puppeteer
        run: npx puppeteer browsers install chrome
        
      - name: ðŸ½ï¸ Process menu data
        id: process_menu
        run: |
          echo "Starting menu processing..."
          cat > process_workflow.js << 'EOF'
          import { processMenu, validateEnvironment } from './backend/processor.js';
          import dotenv from 'dotenv';
          
          // GitHub Actions í™˜ê²½ë³€ìˆ˜ëŠ” ìžë™ìœ¼ë¡œ ë¡œë“œë¨
          async function main() {
            try {
              console.log('ðŸš€ GitHub Actions - ë©”ë‰´ ì²˜ë¦¬ ì‹œìž‘');
              
              // í™˜ê²½ë³€ìˆ˜ í™•ì¸
              const missing = validateEnvironment();
              if (missing.length > 0) {
                console.error('Missing environment variables:', missing);
                process.exit(1);
              }
              
              // ë©”ë‰´ ì²˜ë¦¬ ì‹¤í–‰
              const result = await processMenu(true);
              
              console.log('âœ… ë©”ë‰´ ì²˜ë¦¬ ì™„ë£Œ');
              console.log(`ðŸ“Š ë©”ë‰´ ê°œìˆ˜: ${result.menuItems.length}`);
              console.log(`â±ï¸ ì†Œìš”ì‹œê°„: ${(result.duration / 1000).toFixed(2)}ì´ˆ`);
              console.log(`ðŸ”— íŒŒì¼ URL: ${result.fileUrl}`);
              
              // GitHub Actions ì¶œë ¥ ì„¤ì •
              console.log(`::set-output name=success::true`);
              console.log(`::set-output name=menu_count::${result.menuItems.length}`);
              console.log(`::set-output name=file_url::${result.fileUrl}`);
              console.log(`::set-output name=duration::${result.duration}`);
              
            } catch (error) {
              console.error('âŒ ì²˜ë¦¬ ì‹¤íŒ¨:', error.message);
              console.log(`::set-output name=success::false`);
              console.log(`::set-output name=error::${error.message}`);
              process.exit(1);
            }
          }
          
          main();
          EOF
          
          node process_workflow.js
          
      - name: ðŸ“Š Create summary
        if: always()
        run: |
          if [ "${{ steps.process_menu.outputs.success }}" == "true" ]; then
            echo "## âœ… Menu Update Success" >> $GITHUB_STEP_SUMMARY
            echo "- **Menu Items:** ${{ steps.process_menu.outputs.menu_count }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Duration:** $((${{ steps.process_menu.outputs.duration }} / 1000))s" >> $GITHUB_STEP_SUMMARY
            echo "- **File URL:** ${{ steps.process_menu.outputs.file_url }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Time:** $(date '+%Y-%m-%d %H:%M:%S KST')" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Menu Update Failed" >> $GITHUB_STEP_SUMMARY
            echo "- **Error:** ${{ steps.process_menu.outputs.error }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Time:** $(date '+%Y-%m-%d %H:%M:%S KST')" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: ðŸ“± Notify on failure
        if: failure()
        run: |
          echo "Menu update failed. Please check the workflow logs."
          # í•„ìš”ì‹œ Slack, Discord ë“±ìœ¼ë¡œ ì•Œë¦¼ ì¶”ê°€ ê°€ëŠ¥
          
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          rm -f process_workflow.js