name: Daily Menu Update

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 8ì‹œ (UTC 23:00 = KST 08:00)
    - cron: '0 23 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©
    inputs:
      force_update:
        description: 'ê°•ì œ ì—…ë°ì´íŠ¸ (true/false)'
        required: false
        default: 'false'

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
  GITHUB_OWNER: ${{ github.repository_owner }}
  GITHUB_REPO: ${{ github.event.repository.name }}
  GITHUB_BRANCH: main

jobs:
  update-menu:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ›’ Checkout repository
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ðŸ“¥ Install dependencies
        run: npm install --production
        
      - name: ðŸ”§ Install additional dependencies for GitHub Actions
        run: npm install dotenv
        
      - name: ðŸŒ Setup Puppeteer with Chrome
        run: |
          # Puppeteerê°€ Chromeì„ ìžë™ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œí•˜ë„ë¡ ì„¤ì •
          echo "PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=false" >> $GITHUB_ENV
          echo "PUPPETEER_EXECUTABLE_PATH=" >> $GITHUB_ENV
          
          # Linux ì˜ì¡´ì„± ì„¤ì¹˜
          sudo apt-get update
          sudo apt-get install -y \
            gconf-service \
            libasound2 \
            libatk1.0-0 \
            libc6 \
            libcairo2 \
            libcups2 \
            libdbus-1-3 \
            libexpat1 \
            libfontconfig1 \
            libgcc1 \
            libgconf-2-4 \
            libgdk-pixbuf2.0-0 \
            libglib2.0-0 \
            libgtk-3-0 \
            libnspr4 \
            libpango-1.0-0 \
            libpangocairo-1.0-0 \
            libstdc++6 \
            libx11-6 \
            libx11-xcb1 \
            libxcb1 \
            libxcomposite1 \
            libxcursor1 \
            libxdamage1 \
            libxext6 \
            libxfixes3 \
            libxi6 \
            libxrandr2 \
            libxrender1 \
            libxss1 \
            libxtst6 \
            ca-certificates \
            fonts-liberation \
            libappindicator1 \
            libnss3 \
            lsb-release \
            xdg-utils \
            wget
          
          # Puppeteer ìž¬ì„¤ì¹˜ë¡œ Chrome ë‹¤ìš´ë¡œë“œ
          npm install puppeteer
        
      - name: ðŸ½ï¸ Process menu data
        id: process_menu
        run: |
          echo "Starting menu processing..."
          echo "Environment variables check:"
          echo "OPENAI_API_KEY: ${OPENAI_API_KEY:0:10}..."
          echo "GITHUB_TOKEN: ${GITHUB_TOKEN:0:10}..."
          echo "GITHUB_OWNER: $GITHUB_OWNER"
          echo "GITHUB_REPO: $GITHUB_REPO"
          echo "GITHUB_BRANCH: $GITHUB_BRANCH"
          echo "Working directory: $(pwd)"
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo ""
          
          node github-actions-workflow.js
          
      - name: ðŸ“Š Create summary
        if: always()
        run: |
          echo "## ðŸ“Š Menu Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "- **Result:** âœ… Successfully updated menu data" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Result:** âŒ Failed to update menu data" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- **Workflow Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          
      - name: ðŸ“± Notify on failure
        if: failure()
        run: |
          echo "Menu update failed. Please check the workflow logs."
          # í•„ìš”ì‹œ Slack, Discord ë“±ìœ¼ë¡œ ì•Œë¦¼ ì¶”ê°€ ê°€ëŠ¥
          
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          echo "Workflow completed at $(date)"